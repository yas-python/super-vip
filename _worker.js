// <!--GAMFC--> version base on commit 566f53a85023bfdb4b63749ce0d174aebb9bb167, time is 2025-10-28 16:16:44 UTC<!--We are all REvil-->
// @ts-ignore

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','proxyIPs':['nima.nscl.ir:443','bpb.yousef.isegaro.com:443'],'scamalytics':{'username':'revilseptember','apiKey':'b2fc368184deb3d8ac914bd776b8215fe899dd8fef69fbaba77511acfbdeca0d','baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':![],'relayMode':![],'address':''},async 'fromEnv'(a){let b=null;if(a['PROXY_KV']){const f=a['PROXY_IP_KEY']||'BEST_PROXY_IP';try{b=await a['PROXY_KV']['get'](f);if(b)console['log']('Using\x20proxy\x20IP\x20from\x20KV:\x20'+b);}catch(g){console['error']('Failed\x20to\x20read\x20from\x20PROXY_KV:\x20'+g['message']);}}if(!b){b=a['PROXYIP'];if(b)console['log']('Using\x20proxy\x20IP\x20from\x20env.PROXYIP:\x20'+b);}if(!b){b=this['proxyIPs'][Math['floor'](Math['random']()*this['proxyIPs']['length'])];if(b)console['log']('Using\x20proxy\x20IP\x20from\x20hardcoded\x20list:\x20'+b);}!b&&(b=this['proxyIPs'][0x0]);const [c,d='443']=b['split'](':');return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':parseInt(d,0xa),'proxyAddress':b,'scamalytics':{'username':a['SCAMALYTICS_USERNAME']||this['scamalytics']['username'],'apiKey':a['SCAMALYTICS_API_KEY']||this['scamalytics']['apiKey'],'baseUrl':a['SCAMALYTICS_BASEURL']||this['scamalytics']['baseUrl']},'socks5':{'enabled':!!a['SOCKS5'],'relayMode':a['SOCKS5_RELAY']==='true'||this['socks5']['relayMode'],'address':a['SOCKS5']||this['socks5']['address']}};}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2};function generateUUID(){return crypto['randomUUID']();}function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isExpired(a,b){if(!a||!b)return!![];const c=b['includes'](':')&&b['split'](':')['length']===0x2?b+':00':b,d=c['split']('.')[0x0],e=new Date(a+'T'+d+'Z');return e<=new Date()||isNaN(e);}function formatBytes(a){if(a===0x0)return'0\x20Bytes';const b=0x400,c=['Bytes','KB','MB','GB','TB'],d=Math['floor'](Math['log'](a)/Math['log'](b));return parseFloat((a/Math['pow'](b,d))['toFixed'](0x2))+'\x20'+c[d];}async function getUserData(a,b,c){if(!isValidUUID(b))return null;if(!a['DB']||!a['USER_KV'])return null;const d='user:'+b;try{const h=await a['USER_KV']['get'](d,'json');if(h&&h['uuid'])return h;}catch(i){}const f=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!f)return null;const g=a['USER_KV']['put'](d,JSON['stringify'](f),{'expirationTtl':0xe10});if(c)c['waitUntil'](g);else await g;return f;}async function updateUsage(a,b,c,d){if(c<=0x0||!b)return;try{const e=Math['round'](c),f=a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](e,b)['run'](),g=a['USER_KV']['delete']('user:'+b);if(d)d['waitUntil'](Promise['all']([f,g]));else await Promise['all']([f,g]);}catch(h){console['error']('Failed\x20to\x20update\x20usage\x20for\x20'+b+':',h);}}const byteToHex=Array['from']({'length':0x100},(a,b)=>(b+0x100)['toString'](0x10)['slice'](0x1));function unsafeStringify(a,b=0x0){return(byteToHex[a[b]]+byteToHex[a[b+0x1]]+byteToHex[a[b+0x2]]+byteToHex[a[b+0x3]]+'-'+byteToHex[a[b+0x4]]+byteToHex[a[b+0x5]]+'-'+byteToHex[a[b+0x6]]+byteToHex[a[b+0x7]]+'-'+byteToHex[a[b+0x8]]+byteToHex[a[b+0x9]]+'-'+byteToHex[a[b+0xa]]+byteToHex[a[b+0xb]]+byteToHex[a[b+0xc]]+byteToHex[a[b+0xd]]+byteToHex[a[b+0xe]]+byteToHex[a[b+0xf]])['toLowerCase']();}function stringify(a,b=0x0){const c=unsafeStringify(a,b);if(!isValidUUID(c))throw new TypeError('Stringified\x20UUID\x20is\x20invalid');return c;}function generateRandomPath(a=0xc,b=''){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let d='';for(let e=0x0;e<a;e++)d+=c['charAt'](Math['floor'](Math['random']()*c['length']));return'/'+d+(b?'?'+b:'');}const CORE_PRESETS={'xray':{'tls':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':{}},'tcp':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'none','fp':'chrome','extra':{}}},'sb':{'tls':{'path':()=>generateRandomPath(0x12),'security':'tls','fp':'firefox','alpn':'h3','extra':CONST['ED_PARAMS']},'tcp':{'path':()=>generateRandomPath(0x12),'security':'none','fp':'firefox','extra':CONST['ED_PARAMS']}}};function makeName(a,b){return a+'-'+b['toUpperCase']();}function createVlessLink({userID:a,address:b,port:c,host:d,path:e,security:f,sni:g,fp:h,alpn:i,extra:extra={},name:j}){const l=new URLSearchParams({'type':'ws','host':d,'path':e});if(f)l['set']('security',f);if(g)l['set']('sni',g);if(h)l['set']('fp',h);if(i)l['set']('alpn',i);for(const [m,n]of Object['entries'](extra))l['set'](m,n);return'vless://'+a+'@'+b+':'+c+'?'+l['toString']()+'#'+encodeURIComponent(j);}function buildLink({core:a,proto:b,userID:c,hostName:d,address:e,port:f,tag:g}){const h=CORE_PRESETS[a][b];return createVlessLink({'userID':c,'address':e,'port':f,'host':d,'path':h['path'](),'security':h['security'],'sni':h['security']==='tls'?d:undefined,'fp':h['fp'],'alpn':h['alpn'],'extra':h['extra'],'name':makeName(g,b)});}const pick=a=>a[Math['floor'](Math['random']()*a['length'])];async function handleIpSubscription(a,b,c){const d=[c,'creativecommons.org','mail.tm','temp-mail.org','mdbmax.com','check-host.net','kodambroker.com','iplocation.io','whatismyip.org','whatismyip.com','www.speedtest.net','sky.rethinkdns.com','cfip.1323123.xyz','go.inmobi.com','whatismyipaddress.com','cf.090227.xyz','cdnjs.com','zula.ir'],f=[0x1bb,0x20fb,0x805,0x823,0x827,0x830],g=[0x50,0x1f90,0x22b0,0x804,0x822,0x826,0x82f];let h=[];const i=c['endsWith']('.pages.dev');d['forEach']((j,k)=>{h['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':j,'port':pick(f),'tag':'D'+(k+0x1)}));if(!i)h['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':j,'port':pick(g),'tag':'D'+(k+0x1)}));});try{const j=await fetch('https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json');if(j['ok']){const k=await j['json'](),l=[...k['ipv4']??[],...k['ipv6']??[]]['slice'](0x0,0x14)['map'](m=>m['ip']);l['forEach']((m,n)=>{const o=m['includes'](':')?'['+m+']':m;h['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':o,'port':pick(f),'tag':'IP'+(n+0x1)}));if(!i)h['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':o,'port':pick(g),'tag':'IP'+(n+0x1)}));});}}catch(m){}return new Response(btoa(h['join']('\x0a')),{'headers':{'Content-Type':'text/plain;charset=utf-8','alt-svc':'h3=\x22:443\x22;\x20ma=0'}});}const adminLoginHTML='<!DOCTYPE\x20html><html\x20lang=\x22en\x22><head><meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22><title>Admin\x20Login</title><style>body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background:#121212;font-family:-apple-system,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,Helvetica,Arial,sans-serif}.login-container{background:#1e1e1e;padding:40px;border-radius:12px;box-shadow:0\x204px\x2020px\x20rgba(0,0,0,.5);text-align:center;width:320px;border:1px\x20solid\x20#333}h1{color:#fff;margin-bottom:24px;font-weight:500}input[type=password]{background:#2c2c2c;border:1px\x20solid\x20#444;color:#fff;padding:12px;border-radius:8px;margin-bottom:20px;font-size:16px;width:100%}input:focus{outline:none;border-color:#007aff;box-shadow:0\x200\x200\x202px\x20rgba(0,122,255,.3)}button{background:#007aff;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:.2s}button:hover{background:#005ecb}.error{color:#ff3b30;margin-top:15px;font-size:14px}</style></head><body><div\x20class=\x22login-container\x22><h1>Admin\x20Login</h1><form\x20method=\x22POST\x22\x20action=\x22/admin\x22><input\x20type=\x22password\x22\x20name=\x22password\x22\x20placeholder=\x22Enter\x20admin\x20password\x22\x20required><button\x20type=\x22submit\x22>Login</button></form></div></body></html>',adminPanelHTML='<!DOCTYPE\x20html><html\x20lang=\x22en\x22><head><meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22><title>Admin\x20Dashboard</title><style>:root{--bg-main:#111827;--bg-card:#1F2937;--border:#374151;--text-primary:#F9FAFB;--text-secondary:#9CA3AF;--accent:#3B82F6;--danger:#EF4444;--success:#22C55E;--warning:#F59E0B}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,sans-serif;background:var(--bg-main);color:var(--text-primary);font-size:14px}.container{max-width:1200px;margin:40px\x20auto;padding:0\x2020px}h1,h2{font-weight:600}h1{font-size:24px;margin-bottom:20px}h2{font-size:18px;border-bottom:1px\x20solid\x20var(--border);padding-bottom:10px;margin-bottom:20px}.card{background:var(--bg-card);border-radius:8px;padding:24px;border:1px\x20solid\x20var(--border);box-shadow:0\x204px\x206px\x20rgba(0,0,0,.1)}.dashboard-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}.stat-card{background:#1F2937;padding:16px;border-radius:8px;text-align:center;border:1px\x20solid\x20var(--border)}.stat-value{font-size:24px;font-weight:600;color:var(--accent)}.stat-label{font-size:12px;color:var(--text-secondary);text-transform:uppercase;margin-top:4px}.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;align-items:flex-end}.form-group{display:flex;flex-direction:column}label{margin-bottom:8px;font-weight:500;color:var(--text-secondary)}.input-group{display:flex}input,select{width:100%;box-sizing:border-box;background:#374151;border:1px\x20solid\x20#4B5563;color:var(--text-primary);padding:10px;border-radius:6px;font-size:14px;transition:.2s}input:focus,select:focus{outline:none;border-color:var(--accent)}.btn{padding:10px\x2016px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:#2563EB}.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#DC2626}.btn-secondary{background:#4B5563;color:#fff}.btn-secondary:hover{background:#6B7280}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:12px\x2016px;text-align:left;border-bottom:1px\x20solid\x20var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}th{color:var(--text-secondary);font-weight:600;font-size:12px;text-transform:uppercase}td{color:var(--text-primary);font-family:\x22SF\x20Mono\x22,monospace;font-size:13px}.status-badge{padding:4px\x208px;border-radius:12px;font-size:12px;font-weight:600;display:inline-block}.status-active{background:var(--success);color:#064E3B}.status-expired{background:var(--warning);color:#78350F}.uuid-cell{display:flex;gap:8px;align-items:center}.btn-copy-uuid{padding:4px\x208px;font-size:11px;background:rgba(59,130,246,.1);border:1px\x20solid\x20rgba(59,130,246,.3);color:var(--accent);border-radius:4px;cursor:pointer}.btn-copy-uuid:hover{background:rgba(59,130,246,.2)}.btn-copy-uuid.copied{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.3);color:var(--success)}#toast{position:fixed;top:20px;right:20px;background:var(--bg-card);color:#fff;padding:15px\x2020px;border-radius:8px;z-index:1001;display:none;border:1px\x20solid\x20var(--border);box-shadow:0\x204px\x2012px\x20rgba(0,0,0,.3);opacity:0;transition:.3s}#toast.show{display:block;opacity:1}#toast.error{border-left:5px\x20solid\x20var(--danger)}#toast.success{border-left:5px\x20solid\x20var(--success)}</style></head><body><div\x20class=\x22container\x22><h1>Admin\x20Dashboard</h1><div\x20class=\x22dashboard-stats\x22><div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22total-users\x22>0</div><div\x20class=\x22stat-label\x22>Total\x20Users</div></div><div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22active-users\x22>0</div><div\x20class=\x22stat-label\x22>Active\x20Users</div></div><div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22expired-users\x22>0</div><div\x20class=\x22stat-label\x22>Expired\x20Users</div></div><div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22total-traffic\x22>0\x20KB</div><div\x20class=\x22stat-label\x22>Total\x20Traffic</div></div></div><div\x20class=\x22card\x22><h2>Create\x20User</h2><form\x20id=\x22createUserForm\x22\x20class=\x22form-grid\x22><div\x20class=\x22form-group\x22\x20style=\x22grid-column:1/-1\x22><label>UUID</label><div\x20class=\x22input-group\x22><input\x20type=\x22text\x22\x20id=\x22uuid\x22\x20required><button\x20type=\x22button\x22\x20id=\x22generateUUID\x22\x20class=\x22btn\x20btn-secondary\x22>Generate</button></div></div><div\x20class=\x22form-group\x22><label>Expiry\x20Date</label><input\x20type=\x22date\x22\x20id=\x22expiryDate\x22\x20required></div><div\x20class=\x22form-group\x22><label>Expiry\x20Time</label><input\x20type=\x22time\x22\x20id=\x22expiryTime\x22\x20step=\x221\x22\x20required></div><div\x20class=\x22form-group\x22><label>Notes</label><input\x20type=\x22text\x22\x20id=\x22notes\x22></div><div\x20class=\x22form-group\x22><label>Data\x20Limit</label><div\x20class=\x22input-group\x22><input\x20type=\x22number\x22\x20id=\x22dataLimit\x22\x20min=\x220\x22\x20step=\x220.01\x22><select\x20id=\x22dataUnit\x22><option>KB</option><option>MB</option><option>GB</option><option>TB</option><option\x20value=\x22unlimited\x22\x20selected>Unlimited</option></select></div></div><div\x20class=\x22form-group\x22><label></label><button\x20type=\x22submit\x22\x20class=\x22btn\x20btn-primary\x22>Create</button></div></form></div><div\x20class=\x22card\x22\x20style=\x22margin-top:30px\x22><h2>User\x20List</h2><input\x20type=\x22text\x22\x20id=\x22searchInput\x22\x20class=\x22search-input\x22\x20placeholder=\x22Search...\x22><button\x20id=\x22deleteSelected\x22\x20class=\x22btn\x20btn-danger\x22\x20style=\x22margin-bottom:16px\x22>Delete\x20Selected</button><table><thead><tr><th><input\x20type=\x22checkbox\x22\x20id=\x22selectAll\x22></th><th>UUID</th><th>Created</th><th>Expiry</th><th>Status</th><th>Notes</th><th>Limit</th><th>Used</th><th>Actions</th></tr></thead><tbody\x20id=\x22userList\x22></tbody></table></div></div><div\x20id=\x22toast\x22></div><script>/*\x20Admin\x20JS\x20will\x20be\x20injected\x20in\x20handleAdminRequest\x20*/</script></body></html>';export default{async 'fetch'(a,b,c){let d;const f={'alt-svc':'h3=\x22:443\x22;\x20ma=0'};try{d=await Config['fromEnv'](b);}catch(k){return new Response('Config\x20Error:\x20'+k['message'],{'status':0x1f7,'headers':f});}const g=new URL(a['url']);if(g['pathname']==='/health')return new Response('OK',{'headers':f});if(g['pathname']['startsWith']('/admin'))return await handleAdminRequest(a,b,c,adminLoginHTML,adminPanelHTML);const h=a['headers']['get']('Upgrade');if(h?.['toLowerCase']()==='websocket'){if(!b['DB']||!b['USER_KV'])return new Response('Not\x20configured',{'status':0x1f7,'headers':f});return await ProtocolOverWSHandler(a,d,b,c);}const i=async l=>{const m=g['pathname']['slice'](('/'+l+'/')['length']);if(!isValidUUID(m))return new Response('Invalid\x20UUID',{'status':0x190,'headers':f});const n=await getUserData(b,m,c);if(!n||isExpired(n['expiration_date'],n['expiration_time'])||n['traffic_limit']&&n['traffic_used']>=n['traffic_limit'])return new Response('Forbidden',{'status':0x193,'headers':f});return await handleIpSubscription(l,m,g['hostname']);};if(g['pathname']['startsWith']('/xray/'))return i('xray');if(g['pathname']['startsWith']('/sb/'))return i('sb');const j=g['pathname']['slice'](0x1);if(isValidUUID(j)){const l=await getUserData(b,j,c);if(!l)return new Response('Invalid\x20user',{'status':0x193,'headers':f});return handleUserPanel(j,g['hostname'],d['proxyAddress'],l);}if(b['ROOT_PROXY_URL'])try{const m=new URL(b['ROOT_PROXY_URL']),n=new URL(a['url']);n['hostname']=m['hostname'],n['protocol']=m['protocol'],n['port']=m['port'];const o=new Request(n,a);o['headers']['set']('Host',m['hostname']),o['headers']['set']('X-Forwarded-For',a['headers']['get']('CF-Connecting-IP')||'');const p=await fetch(o),q=new Headers(p['headers']);return q['delete']('Content-Security-Policy'),q['delete']('X-Frame-Options'),new Response(p['body'],{'status':p['status'],'headers':q});}catch(r){return new Response('Proxy\x20error:\x20'+r['message'],{'status':0x1f6,'headers':f});}return new Response('Not\x20found',{'status':0x194,'headers':f});}};